trigger: 
  branches:
    include:
    - '*'
pool: cholpona

resources:
  repositories: 
  - repository: ag-fraud-advisor
    type: git 
    name: ag-fraud-advisor/ag-fraud-advisor
    ref: refs/heads/Test
stages: 
- stage: sw
  jobs:
  - job: sw
    steps:
    - script: |
        git config user.email "$(Build.RequestedForEmail)"
        git config user.name "$(Build.RequestedFor)"
        echo "SOURCE BRANCH IS $BUILD_SOURCEBRANCH"
        if [ "$BUILD_SOURCEBRANCH" == "refs/heads/main" ]; then
            echo "Building main branch so no merge is needed."
            exit
        fi
        
        sourceBranch="origin/${BUILD_SOURCEBRANCH/refs\/heads\//}"
        echo "GIT CHECKOUT MAIN"
        git checkout main
        echo "GIT STATUS"
        git status
        echo "GIT MERGE"
        git merge "$sourceBranch" -m "Merge to main" --allow-unrelated-histories
        echo "GIT STATUS"
        git status
        echo "GIT PUSH"
        git push origin
        echo "GIT STATUS"
        git status

        # current_branch=$(echo $(Build.SourceBranch) | awk -F '/' '{print $3}')
        # git fetch -a
        # # git checkout origin/main
        # # git pull origin main
        # # git checkout -b '$(current_branch)'
        # # git merge origin main
        # # echo $current_branch
        # #2 git checkout main
        # # git pull origin main
        # # git merge origin/$current_branch
        # # git push origin main
        # rm -fr ".git/rebase-merge"
        # # git config pull.rebase false
        # # git checkout $current_branch
        # # git pull
        # # git pull origin main --allow-unrelated-histories
        # # git checkout main 
        # # git pull
        # # git merge --no-ff --no-commit $current_branch
        # # git commit --no-edit
        # # git push origin main
        # git checkout main
        # git reset --hard origin/main
        # git merge origin/$current_branch --allow-unrelated-histories
        # git push origin main
      
